<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>è¦ªæˆšç¨±å‘¼è¨ˆç®—æ©Ÿï¼ˆå°ç£ï¼‰</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#9b111e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-512.png">

  <style>
    :root{
      --red:#9b111e;
      --gold:#d4af37;
      --bg:#fff7ea;
      --card:#ffffff;
      --text:#1f1f1f;
      --muted:#6b6b6b;
      --line:#ead7b2;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(212,175,55,.18), transparent 55%),
        radial-gradient(1000px 600px at 90% 0%, rgba(155,17,30,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.55;
      padding: 18px;
    }
    .wrap{ max-width: 980px; margin:0 auto; }
    .hero{
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(155,17,30,.92), rgba(179,18,34,.92));
      color:#fff;
      padding: 18px 18px 16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-40px -40px auto auto;
      width:220px; height:220px;
      background: radial-gradient(circle at 30% 30%, rgba(212,175,55,.55), rgba(212,175,55,0) 65%);
      transform: rotate(20deg);
    }
    .title{ margin:0; font-size: 22px; letter-spacing:.5px; }
    .subtitle{ margin:6px 0 0; color: rgba(255,255,255,.86); font-size: 14px; }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 14px;
      padding: 16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 60px 1fr 60px 1fr;
      gap: 10px;
      align-items:center;
      margin-top: 10px;
    }
    .op{ text-align:center; font-size: 18px; color: var(--red); font-weight:700; }

    select,input,textarea,button{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid #e7e1d3;
      font-size: 16px;
      background:#fff;
    }
    input[readonly]{ background: #fffdf8; border-style:dashed; }
    textarea{ min-height: 120px; resize: vertical; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .toolbar > div{ flex:1; min-width: 240px; }

    .btns{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 10px; }
    button{ cursor:pointer; background: linear-gradient(180deg, #fff, #fff7ea); border: 1px solid rgba(0,0,0,.06); }
    .btn-primary{
      background: linear-gradient(180deg, rgba(212,175,55,.95), rgba(212,175,55,.78));
      border: 1px solid rgba(155,17,30,.25);
      font-weight: 700;
    }
    .btn-red{
      background: linear-gradient(180deg, rgba(155,17,30,.95), rgba(179,18,34,.92));
      border: 1px solid rgba(212,175,55,.35);
      color:#fff;
      font-weight: 700;
    }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;
      font-size: 12px;
      margin-right: 6px;
      color: var(--muted);
    }
    .result{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed #e2c98d;
      background: #fffaf0;
    }
    .warn{ color:#b00020; font-weight:700; }
    .muted{ color:var(--muted); font-size: 13px; }
    code{ background:#fff; border:1px solid #eee; padding: 1px 6px; border-radius: 8px; }

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr 40px 1fr; }
      .grid .eq, .grid input{ grid-column: 1 / -1; }
      .grid .eq{ display:none; }
      .two{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1 class="title">ğŸ§§ è¦ªæˆšç¨±å‘¼è¨ˆç®—æ©Ÿï¼ˆå°ç£ï¼‰</h1>
      <div class="subtitle">Aç¨±è¬‚ ï¼‹ Bç¨±è¬‚ ï¼ Cç¨±è¬‚ï½œæ”¯æ´æ–‡å­—è§£æï½œPhase 1ï¼šç¥–è¼©æ—ç³»ï¼†åŒè¼©å§»è¦ªè£œé½Š</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div>
          <div class="muted" style="margin-bottom:6px;">æˆ‘çš„èº«åˆ†ï¼ˆç”¨æ–¼åˆ¤æ–·ï¼šå…¬å©† / å²³çˆ¶æ¯ï¼‰</div>
          <select id="selfRole">
            <option value="unknown">ä¸æŒ‡å®šï¼ˆçµ¦ä¸­æ€§æç¤ºï¼‰</option>
            <option value="husband">æˆ‘æ˜¯ä¸ˆå¤«ï¼ˆé…å¶çˆ¶æ¯ï¼å²³çˆ¶/å²³æ¯ï¼‰</option>
            <option value="wife">æˆ‘æ˜¯å¦»å­ï¼ˆé…å¶çˆ¶æ¯ï¼å…¬å…¬/å©†å©†ï¼‰</option>
          </select>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">æ¨¡å¼</div>
          <select id="mode">
            <option value="strict">åš´æ ¼æ¨¡å¼ï¼ˆæ‰¾ä¸åˆ°å°±æç¤ºåŠ è¦å‰‡ï¼‰</option>
            <option value="hint">æç¤ºæ¨¡å¼ï¼ˆå¯èƒ½å¤šè§£å°±æç¤ºä½ ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <select id="a"></select>
        <div class="op">ï¼‹</div>
        <select id="b"></select>
        <div class="op eq">ï¼</div>
        <input id="c" readonly placeholder="çµæœ C ç¨±è¬‚" />
      </div>

      <div class="btns">
        <button class="btn-primary" type="button" onclick="useResultAsA()">æŠŠçµæœç•¶ä¸‹ä¸€æ¬¡çš„ A</button>
        <button type="button" onclick="swapAB()">äº¤æ› A/B</button>
        <button type="button" onclick="clearAll()">æ¸…ç©º</button>
      </div>

      <div class="result" id="explain"></div>
    </div>

    <div class="card">
      <div style="font-weight:800; color:var(--red);">ğŸ” æ–‡å­—è§£æï¼ˆå¥½ç©ï¼ï¼‰</div>
      <div class="muted" style="margin-top:6px;">è¼¸å…¥åƒã€Œ<b>çˆºçˆºçš„å“¥å“¥</b>ã€ã€Œ<b>çˆ¸çˆ¸çš„å¦¹å¦¹çš„å…’å­</b>ã€â†’ æœƒä¸€æ­¥æ­¥ç®—å‡ºçµæœï¼ˆä¾ç¾æœ‰è¦å‰‡ï¼‰ã€‚</div>
      <div class="toolbar" style="margin-top:10px;">
        <div style="flex:2; min-width:260px;">
          <input id="expr" placeholder="ä¾‹å¦‚ï¼šçˆºçˆºçš„å“¥å“¥" />
        </div>
        <div style="min-width:180px;">
          <button class="btn-red" type="button" onclick="parseAndCompute()">è§£æä¸¦è¨ˆç®—</button>
        </div>
      </div>
      <div class="muted" id="parseLog" style="margin-top:10px;"></div>
    </div>

    <div class="two">
      <div class="card">
        <div style="font-weight:800; color:var(--red);">âš¡ Phase 1 å¿«é€Ÿæ¸¬è©¦</div>
        <div class="btns" style="margin-top:12px;">
          <button type="button" onclick="quick('çˆºçˆº','å“¥å“¥')">çˆºçˆº + å“¥å“¥ï¼ˆä¼¯å…¬ï¼‰</button>
          <button type="button" onclick="quick('çˆºçˆº','å¼Ÿå¼Ÿ')">çˆºçˆº + å¼Ÿå¼Ÿï¼ˆå”å…¬ï¼‰</button>
          <button type="button" onclick="quick('å¤–å…¬','å¦¹å¦¹')">å¤–å…¬ + å¦¹å¦¹ï¼ˆå§¨å©†ï¼‰</button>
          <button type="button" onclick="quick('å“¥å“¥','è€å©†')">å“¥å“¥ + è€å©†ï¼ˆå«‚å«‚ï¼‰</button>
          <button type="button" onclick="quick('å§Šå§Š','è€å…¬')">å§Šå§Š + è€å…¬ï¼ˆå§Šå¤«ï¼‰</button>
          <button type="button" onclick="quick('ä¼¯å…¬','è€å©†')">ä¼¯å…¬ + è€å©†ï¼ˆä¼¯å©†ï¼‰</button>
        </div>
        <div class="muted" style="margin-top:12px;">
          âœ… é€™ç‰ˆé‡é»è£œé½Šï¼šä¼¯å…¬/å”å…¬/å§‘å©†ã€èˆ…å…¬/å§¨å©†ã€ä¼¯å©†/å”å©†/èˆ…å©†/å§¨å…¬ã€å«‚å«‚/å¼Ÿåª³/å§Šå¤«/å¦¹å¤«
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800; color:var(--red);">ğŸ§© è‡ªè¨‚è¦å‰‡ï¼ˆå¯æ–°å¢/è¦†è“‹ï¼‰</div>
        <div class="muted" style="margin-top:6px;">key ç”¨ <code>A|B</code>ï¼Œvalue ç”¨ç¨±è¬‚å­—ä¸²ï¼ˆå¯å¯«å¤šå€‹ç”¨ <code>/</code> åˆ†éš”ï¼‰</div>
        <textarea id="custom" placeholder='ä¾‹å¦‚ï¼š
{
  "ä¼¯å…¬|å…’å­": "å ‚ä¼¯ï¼ˆæ—è­œç”¨ï¼‰",
  "å§‘å©†|å…’å­": "è¡¨å”ï¼ˆéœ€å¹´é½¡ï¼‰"
}'></textarea>
        <div class="btns">
          <button class="btn-primary" type="button" onclick="applyCustom()">å¥—ç”¨è‡ªè¨‚è¦å‰‡</button>
          <button type="button" onclick="resetCustom()">æ¸…ç©ºè‡ªè¨‚è¦å‰‡</button>
        </div>
        <div id="customMsg" class="muted"></div>
      </div>
    </div>
  </div>

<script>
  // Register Service Worker for offline support
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }

  // ===== å¯é¸ç¨±è¬‚ï¼ˆå°ç£å¸¸ç”¨ + Phase 1 æ“´å……ï¼‰=====
  const options = [
    "æˆ‘",

    // ç›´ç³»
    "çˆ¸çˆ¸","åª½åª½",
    "çˆºçˆº","å¥¶å¥¶",
    "å¤–å…¬","å¤–å©†",
    "å…’å­","å¥³å…’",

    // é…å¶
    "é…å¶","è€å…¬","è€å©†",

    // åŒè¼©
    "å“¥å“¥","å¼Ÿå¼Ÿ","å§Šå§Š","å¦¹å¦¹",

    // çˆ¶ç³»æ—ç³»
    "ä¼¯çˆ¶","å”å”","å§‘å§‘",
    "ä¼¯æ¯","å”æ¯","å§‘ä¸ˆ",

    // æ¯ç³»æ—ç³»
    "èˆ…èˆ…","é˜¿å§¨",
    "èˆ…åª½","å§¨ä¸ˆ",

    // æ™šè¼©
    "ä¾„å­","ä¾„å¥³",
    "å¤–ç”¥","å¤–ç”¥å¥³",

    // å ‚/è¡¨ï¼ˆæç¤ºå¹´é½¡ï¼‰
    "å ‚å“¥","å ‚å¼Ÿ","å ‚å§Š","å ‚å¦¹",
    "è¡¨å“¥","è¡¨å¼Ÿ","è¡¨å§Š","è¡¨å¦¹",

    // ===== Phase 1 æ–°å¢ï¼šç¥–è¼©æ—ç³» =====
    "ä¼¯å…¬","å”å…¬","å§‘å©†",
    "èˆ…å…¬","å§¨å©†",

    // ===== Phase 1 æ–°å¢ï¼šç¥–è¼©å§»è¦ª =====
    "ä¼¯å©†","å”å©†","èˆ…å©†","å§¨å…¬",

    // ===== Phase 1 æ–°å¢ï¼šåŒè¼©å§»è¦ª =====
    "å«‚å«‚","å¼Ÿåª³","å§Šå¤«","å¦¹å¤«"
  ];

  // ===== è¦å‰‡è¡¨ï¼šA + B => C =====
  const baseRules = {
    // æˆ‘ + ...
    "æˆ‘|çˆ¸çˆ¸": "çˆ¸çˆ¸",
    "æˆ‘|åª½åª½": "åª½åª½",
    "æˆ‘|å“¥å“¥": "å“¥å“¥",
    "æˆ‘|å¼Ÿå¼Ÿ": "å¼Ÿå¼Ÿ",
    "æˆ‘|å§Šå§Š": "å§Šå§Š",
    "æˆ‘|å¦¹å¦¹": "å¦¹å¦¹",
    "æˆ‘|é…å¶": "é…å¶",
    "æˆ‘|è€å…¬": "è€å…¬",
    "æˆ‘|è€å©†": "è€å©†",
    "æˆ‘|å…’å­": "å…’å­",
    "æˆ‘|å¥³å…’": "å¥³å…’",

    // çˆ¶æ¯ -> ç¥–çˆ¶æ¯/å¤–ç¥–çˆ¶æ¯
    "çˆ¸çˆ¸|çˆ¸çˆ¸": "çˆºçˆº",
    "çˆºçˆº|å“¥å“¥": "ä¼¯å…¬",
    "çˆºçˆº|å¼Ÿå¼Ÿ": "å”å…¬",
    "çˆºçˆº|å§Šå§Š": "å§‘å©†",
    "çˆºçˆº|å¦¹å¦¹": "å§‘å©†",

    "çˆ¸çˆ¸|åª½åª½": "å¥¶å¥¶",
    "åª½åª½|çˆ¸çˆ¸": "å¤–å…¬",
    "åª½åª½|åª½åª½": "å¤–å©†",

    // çˆ¶æ¯ -> æ—ç³»ï¼ˆä¼¯å”å§‘ / èˆ…å§¨ï¼‰
    "çˆ¸çˆ¸|å“¥å“¥": "ä¼¯çˆ¶",
    "çˆ¸çˆ¸|å¼Ÿå¼Ÿ": "å”å”",
    "çˆ¸çˆ¸|å§Šå§Š": "å§‘å§‘",
    "çˆ¸çˆ¸|å¦¹å¦¹": "å§‘å§‘",

    "åª½åª½|å“¥å“¥": "èˆ…èˆ…",
    "åª½åª½|å¼Ÿå¼Ÿ": "èˆ…èˆ…",
    "åª½åª½|å§Šå§Š": "é˜¿å§¨",
    "åª½åª½|å¦¹å¦¹": "é˜¿å§¨",

    // å…„å¼Ÿå§Šå¦¹ -> ä¾„ / å¤–ç”¥
    "å“¥å“¥|å…’å­": "ä¾„å­",
    "å“¥å“¥|å¥³å…’": "ä¾„å¥³",
    "å¼Ÿå¼Ÿ|å…’å­": "ä¾„å­",
    "å¼Ÿå¼Ÿ|å¥³å…’": "ä¾„å¥³",

    "å§Šå§Š|å…’å­": "å¤–ç”¥",
    "å§Šå§Š|å¥³å…’": "å¤–ç”¥å¥³",
    "å¦¹å¦¹|å…’å­": "å¤–ç”¥",
    "å¦¹å¦¹|å¥³å…’": "å¤–ç”¥å¥³",

    // ===== å§»è¦ªï¼ˆå¸¸ç”¨ï¼‰=====
    "ä¼¯çˆ¶|è€å©†": "ä¼¯æ¯",
    "å”å”|è€å©†": "å”æ¯",
    "å§‘å§‘|è€å…¬": "å§‘ä¸ˆ",
    "èˆ…èˆ…|è€å©†": "èˆ…åª½",
    "é˜¿å§¨|è€å…¬": "å§¨ä¸ˆ",

    // ===== å ‚/è¡¨ï¼ˆæç¤ºå¹´é½¡ï¼‰=====
    "ä¼¯çˆ¶|å…’å­": "å ‚å“¥/å ‚å¼Ÿï¼ˆéœ€å¹´é½¡ï¼‰",
    "ä¼¯çˆ¶|å¥³å…’": "å ‚å§Š/å ‚å¦¹ï¼ˆéœ€å¹´é½¡ï¼‰",
    "å”å”|å…’å­": "å ‚å“¥/å ‚å¼Ÿï¼ˆéœ€å¹´é½¡ï¼‰",
    "å”å”|å¥³å…’": "å ‚å§Š/å ‚å¦¹ï¼ˆéœ€å¹´é½¡ï¼‰",

    "å§‘å§‘|å…’å­": "è¡¨å“¥/è¡¨å¼Ÿï¼ˆéœ€å¹´é½¡ï¼‰",
    "å§‘å§‘|å¥³å…’": "è¡¨å§Š/è¡¨å¦¹ï¼ˆéœ€å¹´é½¡ï¼‰",
    "èˆ…èˆ…|å…’å­": "è¡¨å“¥/è¡¨å¼Ÿï¼ˆéœ€å¹´é½¡ï¼‰",
    "èˆ…èˆ…|å¥³å…’": "è¡¨å§Š/è¡¨å¦¹ï¼ˆéœ€å¹´é½¡ï¼‰",
    "é˜¿å§¨|å…’å­": "è¡¨å“¥/è¡¨å¼Ÿï¼ˆéœ€å¹´é½¡ï¼‰",
    "é˜¿å§¨|å¥³å…’": "è¡¨å§Š/è¡¨å¦¹ï¼ˆéœ€å¹´é½¡ï¼‰",

    // ===========================
    // ===== Phase 1ï¼šç¥–è¼©æ—ç³» =====
    // çˆºçˆºçš„å…„å¼Ÿå§Šå¦¹ï¼šä¼¯å…¬/å”å…¬/å§‘å©†
    "çˆºçˆº|å“¥å“¥": "ä¼¯å…¬",
    "çˆºçˆº|å¼Ÿå¼Ÿ": "å”å…¬",
    "çˆºçˆº|å§Šå§Š": "å§‘å©†",
    "çˆºçˆº|å¦¹å¦¹": "å§‘å©†",

    // å¤–å…¬çš„å…„å¼Ÿå§Šå¦¹ï¼šèˆ…å…¬/å§¨å©†
    "å¤–å…¬|å“¥å“¥": "èˆ…å…¬",
    "å¤–å…¬|å¼Ÿå¼Ÿ": "èˆ…å…¬",
    "å¤–å…¬|å§Šå§Š": "å§¨å©†",
    "å¤–å…¬|å¦¹å¦¹": "å§¨å©†",

    // ===== Phase 1ï¼šç¥–è¼©å§»è¦ª =====
    "ä¼¯å…¬|è€å©†": "ä¼¯å©†",
    "å”å…¬|è€å©†": "å”å©†",
    "èˆ…å…¬|è€å©†": "èˆ…å©†",
    "å§¨å©†|è€å…¬": "å§¨å…¬",

    // ===== Phase 1ï¼šåŒè¼©å§»è¦ª =====
    "å“¥å“¥|è€å©†": "å«‚å«‚",
    "å¼Ÿå¼Ÿ|è€å©†": "å¼Ÿåª³",
    "å§Šå§Š|è€å…¬": "å§Šå¤«",
    "å¦¹å¦¹|è€å…¬": "å¦¹å¤«"
  };

  let customRules = {};

  const $a = document.getElementById("a");
  const $b = document.getElementById("b");
  const $c = document.getElementById("c");
  const $explain = document.getElementById("explain");
  const $selfRole = document.getElementById("selfRole");
  const $mode = document.getElementById("mode");
  const $parseLog = document.getElementById("parseLog");

  function fillSelect(sel){
    sel.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join("");
  }
  function key(a,b){ return `${a}|${b}`; }

  function spouseParentResolution(parent, selfRole){
    if (selfRole === "wife") return parent === "çˆ¸çˆ¸" ? "å…¬å…¬" : "å©†å©†";
    if (selfRole === "husband") return parent === "çˆ¸çˆ¸" ? "å²³çˆ¶" : "å²³æ¯";
    return parent === "çˆ¸çˆ¸" ? "å…¬å…¬/å²³çˆ¶ï¼ˆä¾èº«åˆ†ï¼‰" : "å©†å©†/å²³æ¯ï¼ˆä¾èº«åˆ†ï¼‰";
  }

  function getRule(a,b){
    const k = key(a,b);
    if (customRules[k]) return { value: customRules[k], source:"è‡ªè¨‚è¦å‰‡" };

    if ((a==="é…å¶" || a==="è€å…¬" || a==="è€å©†") && (b==="çˆ¸çˆ¸" || b==="åª½åª½")) {
      return { value: spouseParentResolution(b, $selfRole.value), source:"å…§å»ºè¦å‰‡ï¼ˆé…å¶çˆ¶æ¯ï¼‰" };
    }

    if (baseRules[k]) return { value: baseRules[k], source:"å…§å»ºè¦å‰‡" };
    return null;
  }

  function compute(){
    const a = $a.value;
    const b = $b.value;
    const hit = getRule(a,b);

    if (hit){
      $c.value = hit.value;
      $explain.innerHTML = `
        <div><span class="pill">è¨ˆç®—</span><b>${escapeHtml(a)}</b> ï¼‹ <b>${escapeHtml(b)}</b> ï¼ <b>${escapeHtml(hit.value)}</b></div>
        <div class="muted" style="margin-top:8px;">ä¾†æºï¼š${hit.source}ï¼ˆkeyï¼š<code>${escapeHtml(a)}|${escapeHtml(b)}</code>ï¼‰</div>
      `;
      return;
    }

    $c.value = "";
    if ($mode.value === "hint"){
      $explain.innerHTML = `
        <div class="warn"><span class="pill">å°šæœªå®šç¾©</span><b>${escapeHtml(a)}</b> ï¼‹ <b>${escapeHtml(b)}</b></div>
        <div class="muted" style="margin-top:8px;">
          ä½ å¯ä»¥åœ¨å³å´è‡ªè¨‚è¦å‰‡åŠ ï¼š<code>"${escapeHtml(a)}|${escapeHtml(b)}":"ç¨±è¬‚"</code>
        </div>
      `;
    }else{
      $explain.innerHTML = `
        <div class="warn"><span class="pill">æ‰¾ä¸åˆ°è¦å‰‡</span><b>${escapeHtml(a)}</b> ï¼‹ <b>${escapeHtml(b)}</b></div>
        <div class="muted" style="margin-top:8px;">è«‹ç”¨è‡ªè¨‚è¦å‰‡è£œä¸Šï¼š<code>"${escapeHtml(a)}|${escapeHtml(b)}":"ç¨±è¬‚"</code></div>
      `;
    }
  }

  function quick(a,b){ $a.value=a; $b.value=b; compute(); }
  function useResultAsA(){
    const v = ($c.value || "").trim();
    if (!v) return;
    if (options.includes(v)) {
      $a.value = v;
      compute();
      return;
    }
    $explain.innerHTML = `
      <div class="warn"><span class="pill">ç„¡æ³•é€£é–</span>çµæœæ˜¯ <b>${escapeHtml(v)}</b>ï¼ˆå¯èƒ½å¤šè§£æˆ–å«è¨»è¨˜ï¼‰</div>
      <div class="muted" style="margin-top:8px;">
        ä½ å¯ä»¥ï¼š1) é¸å…¶ä¸­ä¸€å€‹å–®ä¸€ç¨±è¬‚åŠ å…¥ optionsï¼›æˆ– 2) ç”¨è‡ªè¨‚è¦å‰‡æ”¹æˆå–®ä¸€è©ã€‚
      </div>
    `;
  }
  function swapAB(){ const a=$a.value,b=$b.value; $a.value=b; $b.value=a; compute(); }
  function clearAll(){ $a.value="çˆºçˆº"; $b.value="å“¥å“¥"; $parseLog.textContent=""; compute(); }

  function applyCustom(){
    const msg = document.getElementById("customMsg");
    try{
      const txt = document.getElementById("custom").value.trim();
      if(!txt){ customRules={}; msg.textContent="å·²æ¸…ç©ºï¼ˆç›®å‰æ²’æœ‰è‡ªè¨‚è¦å‰‡ï¼‰"; compute(); return; }
      const obj = JSON.parse(txt);
      for (const [k,v] of Object.entries(obj)){
        if(!k.includes("|")) throw new Error(`key å¿…é ˆåŒ…å« "|"ï¼š${k}`);
        if(typeof v !== "string") throw new Error(`value å¿…é ˆæ˜¯å­—ä¸²ï¼š${k}`);
      }
      customRules = obj;
      msg.textContent = `å·²å¥—ç”¨ ${Object.keys(customRules).length} æ¢è‡ªè¨‚è¦å‰‡`;
      compute();
    }catch(e){
      msg.textContent = `è§£æå¤±æ•—ï¼š${e.message}`;
    }
  }
  function resetCustom(){
    document.getElementById("custom").value="";
    customRules={};
    document.getElementById("customMsg").textContent="å·²æ¸…ç©ºï¼ˆç›®å‰æ²’æœ‰è‡ªè¨‚è¦å‰‡ï¼‰";
    compute();
  }

  function normalizeToken(t){
    t = t.trim();
    const map = {
      "çˆ¶è¦ª":"çˆ¸çˆ¸","æ¯è¦ª":"åª½åª½",
      "å¦»å­":"è€å©†","ä¸ˆå¤«":"è€å…¬",
      "é…å¶":"é…å¶",
      "å§":"å§Šå§Š","å§Š":"å§Šå§Š","å¦¹":"å¦¹å¦¹","å¼Ÿ":"å¼Ÿå¼Ÿ","å“¥":"å“¥å“¥",
      "å­":"å…’å­","å¥³":"å¥³å…’",
      "ç¥–çˆ¶":"çˆºçˆº","ç¥–æ¯":"å¥¶å¥¶",
      "å¤–ç¥–çˆ¶":"å¤–å…¬","å¤–ç¥–æ¯":"å¤–å©†"
    };
    return map[t] || t;
  }

  function parseAndCompute(){
    const raw = document.getElementById("expr").value.trim();
    if(!raw){
      $parseLog.innerHTML = `<span class="warn">è«‹å…ˆè¼¸å…¥</span> ä¾‹å¦‚ï¼š<b>çˆºçˆºçš„å“¥å“¥</b>`;
      return;
    }
    const parts = raw.split("çš„").map(normalizeToken).filter(Boolean);

    if (parts.length < 2){
      $parseLog.innerHTML = `<span class="warn">æ ¼å¼ä¸å®Œæ•´</span>ï¼Œè«‹åƒã€Œçˆ¸çˆ¸çš„å¦¹å¦¹ã€æˆ–ã€Œçˆºçˆºçš„å“¥å“¥ã€`;
      return;
    }

    let current = parts[0];
    let log = [`èµ·é»ï¼š<b>${escapeHtml(current)}</b>`];

    for (let i=1; i<parts.length; i++){
      const next = parts[i];
      const hit = getRule(current, next);
      if (!hit){
        log.push(`âŒ <b>${escapeHtml(current)}</b> + <b>${escapeHtml(next)}</b> æ‰¾ä¸åˆ°è¦å‰‡`);
        $parseLog.innerHTML = log.join("<br>");
        if (options.includes(current)) $a.value = current;
        if (options.includes(next)) $b.value = next;
        compute();
        return;
      }
      log.push(`âœ… ${escapeHtml(current)} + ${escapeHtml(next)} = <b>${escapeHtml(hit.value)}</b>`);
      current = hit.value;
    }

    $parseLog.innerHTML = log.join("<br>");

    const lastA = parts[parts.length-2];
    const lastB = parts[parts.length-1];
    if (options.includes(lastA)) $a.value = lastA;
    if (options.includes(lastB)) $b.value = lastB;
    compute();
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  // init
  fillSelect($a); fillSelect($b);
  $a.value="çˆºçˆº";
  $b.value="å“¥å“¥";

  $a.addEventListener("change", compute);
  $b.addEventListener("change", compute);
  $selfRole.addEventListener("change", compute);
  $mode.addEventListener("change", compute);

  compute();
</script>
</body>
</html>
